<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Precios Unitarios - Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .step-indicator {
            transition: all 0.3s ease;
        }
        .step-indicator.active {
            transform: scale(1.1);
        }
        .concept-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .concept-card {
            transition: all 0.3s ease;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modified-input {
            background-color: #fef3c7;
            border-color: #f59e0b;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <h1 class="text-3xl font-bold">Sistema de Precios Unitarios</h1>
            <p class="text-blue-100 mt-2">Constructor Din√°mico de Precios - Demo Session 8 & 9</p>
        </div>
    </header>

    <!-- API Configuration -->
    <div class="container mx-auto px-4 py-4">
        <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <p class="text-sm text-blue-700 mb-2">
                        <strong>API Backend URL:</strong>
                        <span class="text-xs block text-blue-600">Para usar con Railway, reemplaza con: https://tu-proyecto.up.railway.app</span>
                    </p>
                    <div class="flex items-center gap-2">
                        <input type="text" id="apiUrl" value="http://localhost:3004"
                               class="flex-1 px-3 py-2 border border-blue-300 rounded bg-white text-gray-800 text-sm"
                               placeholder="http://localhost:3004 o https://tu-proyecto.up.railway.app">
                        <button onclick="testConnection()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 font-semibold text-sm">
                            üîå Probar Conexi√≥n
                        </button>
                        <span id="connectionStatus" class="text-sm font-semibold"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center flex-1">
                <div id="step-1-indicator" class="step-indicator active flex items-center justify-center w-12 h-12 rounded-full bg-blue-600 text-white font-bold ring-4 ring-blue-200">1</div>
                <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
            </div>
            <div class="flex items-center flex-1">
                <div id="step-2-indicator" class="step-indicator flex items-center justify-center w-12 h-12 rounded-full bg-gray-300 text-gray-600 font-bold">2</div>
                <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
            </div>
            <div class="flex items-center flex-1">
                <div id="step-3-indicator" class="step-indicator flex items-center justify-center w-12 h-12 rounded-full bg-gray-300 text-gray-600 font-bold">3</div>
                <div class="flex-1 h-1 bg-gray-300 mx-2"></div>
            </div>
            <div class="flex items-center">
                <div id="step-4-indicator" class="step-indicator flex items-center justify-center w-12 h-12 rounded-full bg-gray-300 text-gray-600 font-bold">4</div>
            </div>
        </div>

        <!-- Step Labels -->
        <div class="flex justify-between mb-8 text-sm">
            <div class="text-center flex-1"><span class="font-semibold">Configuraci√≥n</span></div>
            <div class="text-center flex-1"><span class="font-semibold">Selecci√≥n</span></div>
            <div class="text-center flex-1"><span class="font-semibold">Personalizaci√≥n</span></div>
            <div class="text-center flex-1"><span class="font-semibold">Resultado</span></div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-8 text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <p class="text-gray-700 font-semibold">Calculando precio unitario...</p>
            </div>
        </div>

        <!-- Error Alert -->
        <div id="errorAlert" class="hidden mb-6 bg-red-50 border-l-4 border-red-400 p-4 rounded">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700" id="errorMessage"></p>
                </div>
            </div>
        </div>

        <!-- Step 1: Configuration -->
        <div id="step1" class="bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 1: Configuraci√≥n del Proyecto</h2>

            <!-- Presets -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Presets R√°pidos</label>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button onclick="applyPreset('privado')" class="p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                        <h3 class="font-bold text-gray-800">Privado Est√°ndar</h3>
                        <p class="text-sm text-gray-600 mt-1">Indirectos 13% ‚Ä¢ Util 12%</p>
                    </button>
                    <button onclick="applyPreset('gobierno')" class="p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                        <h3 class="font-bold text-gray-800">Gobierno</h3>
                        <p class="text-sm text-gray-600 mt-1">Indirectos 8% ‚Ä¢ Util 8%</p>
                    </button>
                    <button onclick="applyPreset('competencia')" class="p-4 border-2 border-gray-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
                        <h3 class="font-bold text-gray-800">Alta Competencia</h3>
                        <p class="text-sm text-gray-600 mt-1">Indirectos 10% ‚Ä¢ Util 5%</p>
                    </button>
                </div>
            </div>

            <!-- Configuration Form -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Cliente</label>
                    <select id="tipoCliente" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="privado">Privado</option>
                        <option value="gobierno">Gobierno</option>
                    </select>
                </div>
                <div></div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Indirectos de Campo (%)</label>
                    <input type="number" id="indirectosCampo" min="0" max="100" step="0.5" value="5"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           oninput="updateTotalFactor()">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Indirectos de Oficina (%)</label>
                    <input type="number" id="indirectosOficina" min="0" max="100" step="0.5" value="8"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           oninput="updateTotalFactor()">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Financiamiento (%)</label>
                    <input type="number" id="financiamiento" min="0" max="100" step="0.5" value="3"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           oninput="updateTotalFactor()">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Utilidad (%)</label>
                    <input type="number" id="utilidad" min="0" max="100" step="0.5" value="12"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                           oninput="updateTotalFactor()">
                </div>
            </div>

            <!-- Total Factor -->
            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                <p class="text-sm text-gray-700">
                    <strong>Factor Total Aproximado:</strong>
                    <span id="totalFactor" class="text-xl font-bold text-blue-600">~1.40x</span>
                </p>
            </div>

            <!-- Next Button -->
            <div class="mt-8 flex justify-end">
                <button onclick="goToStep(2)" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>

        <!-- Step 2: Concept Selection -->
        <div id="step2" class="hidden bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 2: Selecci√≥n de Concepto</h2>

            <!-- Filters -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Partida</label>
                    <select id="filtroPartida" onchange="loadConceptos()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Todas las partidas</option>
                        <option value="Alba√±iler√≠a">Alba√±iler√≠a</option>
                        <option value="Acabados">Acabados</option>
                        <option value="Instalaciones">Instalaciones</option>
                        <option value="Cimentaci√≥n">Cimentaci√≥n</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Buscar</label>
                    <input type="text" id="busqueda" placeholder="Buscar por nombre o clave..."
                           onkeyup="loadConceptos()"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Concepts Grid -->
            <div id="conceptosGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                <!-- Concepts will be loaded here -->
            </div>

            <!-- Navigation -->
            <div class="mt-8 flex justify-between">
                <button onclick="goToStep(1)" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition">
                    ‚Üê Anterior
                </button>
            </div>
        </div>

        <!-- Step 3: Customization -->
        <div id="step3" class="hidden bg-white rounded-lg shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Paso 3: Personalizaci√≥n (Opcional)</h2>

            <div id="conceptoInfo" class="mb-6 p-4 bg-gray-50 rounded-lg">
                <!-- Concept info will be displayed here -->
            </div>

            <!-- Materials Section -->
            <div class="mb-8">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Materiales</h3>
                <div id="materialesList" class="space-y-4">
                    <!-- Materials will be loaded here -->
                </div>
            </div>

            <!-- Navigation -->
            <div class="mt-8 flex justify-between">
                <button onclick="goToStep(2)" class="px-6 py-3 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition">
                    ‚Üê Anterior
                </button>
                <button onclick="calcularPrecio()" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
                    Calcular Precio üéØ
                </button>
            </div>
        </div>

        <!-- Step 4: Result -->
        <div id="step4" class="hidden bg-white rounded-lg shadow-lg p-8">
            <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded mb-6">
                <h2 class="text-2xl font-bold text-green-800">¬°Precio Unitario Calculado!</h2>
            </div>

            <!-- Total Price -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg p-8 mb-6 text-center">
                <p class="text-sm opacity-90 mb-2">Precio Total</p>
                <p id="precioTotal" class="text-5xl font-bold mb-2">$0.00</p>
                <p id="unidadPrecio" class="text-sm opacity-90">por m¬≤</p>
            </div>

            <!-- Cost Breakdown -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Costos Directos</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-600">Materiales</span>
                            <span id="costoMateriales" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-600">Mano de Obra</span>
                            <span id="costoManoObra" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-600">Herramienta</span>
                            <span id="costoHerramienta" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between py-2 border-b border-gray-800">
                            <span class="font-bold">Costo Directo</span>
                            <span id="costoDirecto" class="font-bold">$0.00</span>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Sobrecostos</h3>
                    <div class="space-y-2">
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-600">Indirectos</span>
                            <span id="costoIndirectos" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-600">Subtotal</span>
                            <span id="costoSubtotal" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-600">Financiamiento</span>
                            <span id="costoFinanciamiento" class="font-semibold">$0.00</span>
                        </div>
                        <div class="flex justify-between py-2 border-b">
                            <span class="text-gray-600">Utilidad</span>
                            <span id="costoUtilidad" class="font-semibold">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Materials Detail -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Desglose de Materiales</h3>
                <div id="materialesDesglose" class="bg-gray-50 rounded-lg p-4">
                    <!-- Materials breakdown will be shown here -->
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-4 mb-6">
                <button onclick="window.print()" class="flex-1 px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition">
                    üñ®Ô∏è Imprimir
                </button>
                <button onclick="descargarJSON()" class="flex-1 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">
                    üíæ Descargar JSON
                </button>
            </div>

            <!-- New Calculation -->
            <div class="text-center">
                <button onclick="nuevoCalculo()" class="px-8 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
                    üîÑ Nuevo C√°lculo
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-12 py-6">
        <div class="container mx-auto px-4 text-center">
            <p>Sistema de Precios Unitarios - Demo Session 8 & 9</p>
            <p class="text-sm text-gray-400 mt-2">Backend API: <span id="currentApiUrl">http://localhost:3004</span></p>
        </div>
    </footer>

    <script>
        // Global State
        let currentStep = 1;
        let selectedConcepto = null;
        let conceptoDetalle = null;
        let resultadoCalculo = null;
        let ajustesMateriales = {};

        // Get API URL
        function getApiUrl() {
            const url = document.getElementById('apiUrl').value;
            document.getElementById('currentApiUrl').textContent = url;
            return url;
        }

        // Test API Connection
        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.innerHTML = '<span class="text-gray-500">Probando...</span>';

            try {
                const response = await fetch(`${getApiUrl()}/precios-unitarios/conceptos`);
                if (response.ok) {
                    statusEl.innerHTML = '<span class="text-green-600">‚úì Conectado</span>';
                } else {
                    statusEl.innerHTML = '<span class="text-red-600">‚úó Error de conexi√≥n</span>';
                }
            } catch (error) {
                statusEl.innerHTML = '<span class="text-red-600">‚úó No disponible</span>';
            }
        }

        // Update Total Factor
        function updateTotalFactor() {
            const campo = parseFloat(document.getElementById('indirectosCampo').value) || 0;
            const oficina = parseFloat(document.getElementById('indirectosOficina').value) || 0;
            const financ = parseFloat(document.getElementById('financiamiento').value) || 0;
            const util = parseFloat(document.getElementById('utilidad').value) || 0;

            const indirectosTotal = campo + oficina;
            const factor = 1 + (indirectosTotal + financ + util) / 100;

            document.getElementById('totalFactor').textContent = `~${factor.toFixed(3)}x`;
        }

        // Apply Preset
        function applyPreset(preset) {
            const presets = {
                privado: {
                    tipoCliente: 'privado',
                    indirectosCampo: 5,
                    indirectosOficina: 8,
                    financiamiento: 3,
                    utilidad: 12
                },
                gobierno: {
                    tipoCliente: 'gobierno',
                    indirectosCampo: 3,
                    indirectosOficina: 5,
                    financiamiento: 2,
                    utilidad: 8
                },
                competencia: {
                    tipoCliente: 'privado',
                    indirectosCampo: 4,
                    indirectosOficina: 6,
                    financiamiento: 2,
                    utilidad: 5
                }
            };

            const config = presets[preset];
            document.getElementById('tipoCliente').value = config.tipoCliente;
            document.getElementById('indirectosCampo').value = config.indirectosCampo;
            document.getElementById('indirectosOficina').value = config.indirectosOficina;
            document.getElementById('financiamiento').value = config.financiamiento;
            document.getElementById('utilidad').value = config.utilidad;

            updateTotalFactor();
        }

        // Load Conceptos
        async function loadConceptos() {
            const partida = document.getElementById('filtroPartida').value;
            const busqueda = document.getElementById('busqueda').value;

            try {
                let url = `${getApiUrl()}/precios-unitarios/conceptos?`;
                if (partida) url += `partida=${encodeURIComponent(partida)}&`;
                if (busqueda) url += `busqueda=${encodeURIComponent(busqueda)}`;

                const response = await fetch(url);
                const conceptos = await response.json();

                const grid = document.getElementById('conceptosGrid');
                grid.innerHTML = '';

                if (conceptos.length === 0) {
                    grid.innerHTML = '<p class="col-span-3 text-center text-gray-500">No se encontraron conceptos</p>';
                    return;
                }

                conceptos.forEach(concepto => {
                    const card = document.createElement('button');
                    card.className = 'concept-card p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 text-left transition';
                    card.onclick = () => selectConcepto(concepto.clave);
                    card.innerHTML = `
                        <div class="text-xs font-semibold text-blue-600 mb-1">${concepto.clave}</div>
                        <h3 class="font-bold text-gray-800 mb-2">${concepto.nombre}</h3>
                        <p class="text-sm text-gray-600 mb-2 line-clamp-2">${concepto.descripcion}</p>
                        <div class="flex justify-between items-center text-xs">
                            <span class="bg-gray-100 px-2 py-1 rounded">${concepto.partida}</span>
                            <span class="font-semibold text-gray-700">${concepto.unidad}</span>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            } catch (error) {
                showError('Error al cargar conceptos: ' + error.message);
            }
        }

        // Select Concepto
        async function selectConcepto(clave) {
            try {
                document.getElementById('loadingOverlay').classList.remove('hidden');

                const response = await fetch(`${getApiUrl()}/precios-unitarios/conceptos/${clave}`);
                conceptoDetalle = await response.json();
                selectedConcepto = conceptoDetalle.concepto;

                document.getElementById('loadingOverlay').classList.add('hidden');
                goToStep(3);
                loadCustomizationStep();
            } catch (error) {
                document.getElementById('loadingOverlay').classList.add('hidden');
                showError('Error al cargar concepto: ' + error.message);
            }
        }

        // Load Customization Step
        function loadCustomizationStep() {
            // Concept Info
            const infoEl = document.getElementById('conceptoInfo');
            infoEl.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">${selectedConcepto.clave} - ${selectedConcepto.nombre}</h3>
                        <p class="text-sm text-gray-600 mt-1">${selectedConcepto.descripcion}</p>
                    </div>
                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-semibold">${selectedConcepto.unidad}</span>
                </div>
            `;

            // Materials List
            const materialesEl = document.getElementById('materialesList');
            materialesEl.innerHTML = '';

            conceptoDetalle.materiales.forEach((material, index) => {
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 rounded-lg';
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h4 class="font-semibold text-gray-800">${material.nombre}</h4>
                            <p class="text-sm text-gray-600">${material.clave} - $${material.precioUnitario.toFixed(2)} / ${material.unidad}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-2">
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Cantidad Original</label>
                            <input type="text" value="${material.cantidad} ${material.unidad}" disabled
                                   class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600 mb-1">Cantidad Ajustada</label>
                            <input type="number" id="mat-${index}" value="${material.cantidad}" step="0.001"
                                   class="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                                   onchange="markAsModified(this, ${material.cantidad})">
                        </div>
                    </div>
                `;
                materialesEl.appendChild(div);
            });
        }

        // Mark Input as Modified
        function markAsModified(input, originalValue) {
            const currentValue = parseFloat(input.value);
            if (Math.abs(currentValue - originalValue) > 0.0001) {
                input.classList.add('modified-input');
            } else {
                input.classList.remove('modified-input');
            }
        }

        // Calculate Price
        async function calcularPrecio() {
            try {
                document.getElementById('loadingOverlay').classList.remove('hidden');

                // Get configuration
                const configuracion = {
                    tipoCliente: document.getElementById('tipoCliente').value,
                    indirectosCampo: parseFloat(document.getElementById('indirectosCampo').value),
                    indirectosOficina: parseFloat(document.getElementById('indirectosOficina').value),
                    financiamiento: parseFloat(document.getElementById('financiamiento').value),
                    utilidad: parseFloat(document.getElementById('utilidad').value),
                    cargosAdicionales: 0
                };

                // Get material adjustments
                const ajustes = {};
                conceptoDetalle.materiales.forEach((material, index) => {
                    const input = document.getElementById(`mat-${index}`);
                    const newValue = parseFloat(input.value);
                    if (Math.abs(newValue - material.cantidad) > 0.0001) {
                        ajustes[material.clave] = newValue;
                    }
                });

                // Call API
                const payload = {
                    conceptoClave: selectedConcepto.clave,
                    configuracion: configuracion
                };

                if (Object.keys(ajustes).length > 0) {
                    payload.ajustesPersonalizados = { materiales: ajustes };
                }

                const response = await fetch(`${getApiUrl()}/precios-unitarios/calcular`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                resultadoCalculo = await response.json();

                document.getElementById('loadingOverlay').classList.add('hidden');
                goToStep(4);
                displayResult();
            } catch (error) {
                document.getElementById('loadingOverlay').classList.add('hidden');
                showError('Error al calcular precio: ' + error.message);
            }
        }

        // Display Result
        function displayResult() {
            const costos = resultadoCalculo.costos;
            const desglose = resultadoCalculo.desglose;

            // Format currency
            const fmt = (val) => new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: 'MXN'
            }).format(val);

            // Update totals
            document.getElementById('precioTotal').textContent = fmt(costos.precioUnitarioTotal);
            document.getElementById('unidadPrecio').textContent = `por ${selectedConcepto.unidad}`;

            document.getElementById('costoMateriales').textContent = fmt(costos.materiales);
            document.getElementById('costoManoObra').textContent = fmt(costos.manoObra);
            document.getElementById('costoHerramienta').textContent = fmt(costos.herramienta);
            document.getElementById('costoDirecto').textContent = fmt(costos.costoDirecto);
            document.getElementById('costoIndirectos').textContent = fmt(costos.indirectos);
            document.getElementById('costoSubtotal').textContent = fmt(costos.subtotal);
            document.getElementById('costoFinanciamiento').textContent = fmt(costos.financiamiento);
            document.getElementById('costoUtilidad').textContent = fmt(costos.utilidad);

            // Materials breakdown
            const materialesEl = document.getElementById('materialesDesglose');
            materialesEl.innerHTML = '<div class="space-y-2">';

            desglose.materiales.forEach(mat => {
                materialesEl.innerHTML += `
                    <div class="flex justify-between py-2 border-b border-gray-200">
                        <span class="text-sm text-gray-700">${mat.nombre} (${mat.cantidad} ${mat.unidad})</span>
                        <span class="text-sm font-semibold">${fmt(mat.importe)}</span>
                    </div>
                `;
            });

            materialesEl.innerHTML += '</div>';
        }

        // Download JSON
        function descargarJSON() {
            const dataStr = JSON.stringify(resultadoCalculo, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);

            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', `PU_${selectedConcepto.clave}_${new Date().toISOString().split('T')[0]}.json`);
            linkElement.click();
        }

        // New Calculation
        function nuevoCalculo() {
            selectedConcepto = null;
            conceptoDetalle = null;
            resultadoCalculo = null;
            ajustesMateriales = {};
            goToStep(1);
        }

        // Navigation
        function goToStep(step) {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
                const indicator = document.getElementById(`step-${i}-indicator`);
                indicator.classList.remove('active', 'bg-blue-600', 'text-white', 'ring-4', 'ring-blue-200');
                indicator.classList.add('bg-gray-300', 'text-gray-600');
            }

            // Show current step
            document.getElementById(`step${step}`).classList.remove('hidden');
            const indicator = document.getElementById(`step-${step}-indicator`);
            indicator.classList.add('active', 'bg-blue-600', 'text-white', 'ring-4', 'ring-blue-200');
            indicator.classList.remove('bg-gray-300', 'text-gray-600');

            currentStep = step;

            // Load data for step 2
            if (step === 2 && document.getElementById('conceptosGrid').children.length === 0) {
                loadConceptos();
            }

            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Show Error
        function showError(message) {
            const errorEl = document.getElementById('errorAlert');
            document.getElementById('errorMessage').textContent = message;
            errorEl.classList.remove('hidden');

            setTimeout(() => {
                errorEl.classList.add('hidden');
            }, 5000);
        }

        // Initialize
        updateTotalFactor();
        testConnection();
    </script>
</body>
</html>
